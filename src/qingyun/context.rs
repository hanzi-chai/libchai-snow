use crate::qingyun::{
    encoder::ç®€ç è¦†ç›–, ä¸å¥½çš„å¤§é›†åˆé”®, å…ƒç´ å®‰æ’, å†°é›ªæ¸…éŸµå†³ç­–, å†°é›ªæ¸…éŸµå†³ç­–ç©ºé—´, å†°é›ªæ¸…éŸµç¼–ç ä¿¡æ¯,
    åŠ¨æ€æ‹†åˆ†é¡¹, åŸå§‹éŸ³èŠ‚ä¿¡æ¯, å›ºå®šæ‹†åˆ†é¡¹, å¤§é›†åˆ, å°é›†åˆ, å¸¸ç”¨ç®€ç¹èŒƒå›´, æ‹†åˆ†è¾“å…¥, æ¡ä»¶,
    æ¡ä»¶å…ƒç´ å®‰æ’, ç©ºæ ¼, ç¬”ç”», ç¼–ç , è½¬æ¢, è¿›åˆ¶, éŸ³èŠ‚ä¿¡æ¯, é¢‘åº, é¢‘ç‡,
};
use chai::{
    config::{Condition, Mapped, MappedKey, ValueDescription, é…ç½®},
    contexts::ä¸Šä¸‹æ–‡,
    interfaces::{command_line::è¯»å–æ–‡æœ¬æ–‡ä»¶, é»˜è®¤è¾“å…¥},
    objectives::metric::æŒ‡æ³•æ ‡è®°,
    å…ƒç´ , åŸå§‹å½“é‡ä¿¡æ¯, åŸå§‹é”®ä½åˆ†å¸ƒä¿¡æ¯, æ£±é•œ, é”™è¯¯,
};
use chrono::Local;
use core::panic;
use csv::WriterBuilder;
use indexmap::IndexMap;
use itertools::Itertools;
use regex::Regex;
use rustc_hash::{FxHashMap, FxHashSet};
use serde::Serialize;
use serde_yaml::{from_str, to_string};
use std::{
    fs::{File, read_to_string},
    io::Write,
    path::PathBuf,
};

pub fn å†™å…¥æ–‡æœ¬æ–‡ä»¶<I, T>(path: PathBuf, content: T)
where
    I: Serialize,
    T: IntoIterator<Item = I>,
{
    let mut writer = WriterBuilder::new()
        .delimiter(b'\t')
        .has_headers(false)
        .flexible(true)
        .from_path(path)
        .unwrap();
    for item in content {
        writer.serialize(item).unwrap();
    }
    writer.flush().unwrap();
}

#[derive(Clone)]
pub struct å†°é›ªæ¸…éŸµä¸Šä¸‹æ–‡ {
    pub é…ç½®: é…ç½®,
    pub æ£±é•œ: æ£±é•œ,
    pub åˆå§‹å†³ç­–: å†°é›ªæ¸…éŸµå†³ç­–,
    pub å†³ç­–ç©ºé—´: å†°é›ªæ¸…éŸµå†³ç­–ç©ºé—´,
    pub åŸå§‹é”®ä½åˆ†å¸ƒä¿¡æ¯: åŸå§‹é”®ä½åˆ†å¸ƒä¿¡æ¯,
    pub åŸå§‹å½“é‡ä¿¡æ¯: åŸå§‹å½“é‡ä¿¡æ¯,
    pub å›ºå®šæ‹†åˆ†: Vec<å›ºå®šæ‹†åˆ†é¡¹>,
    pub åŠ¨æ€æ‹†åˆ†: Vec<åŠ¨æ€æ‹†åˆ†é¡¹>,
    pub å—è½¬æ•°å­—: FxHashMap<String, usize>,
    pub æ•°å­—è½¬å—: FxHashMap<usize, String>,
    pub ç®€ä½“é¡ºåº: Vec<usize>,
    pub ç¹ä½“é¡ºåº: Vec<usize>,
    pub ä¸‹æ¸¸å­—æ ¹: FxHashMap<å…ƒç´ , Vec<å…ƒç´ >>,
    pub æ‹¼éŸ³: Vec<éŸ³èŠ‚ä¿¡æ¯>,
}

impl ä¸Šä¸‹æ–‡ for å†°é›ªæ¸…éŸµä¸Šä¸‹æ–‡ {
    type è§£ç±»å‹ = å†°é›ªæ¸…éŸµå†³ç­–;

    fn åºåˆ—åŒ–(&self, è§£: &å†°é›ªæ¸…éŸµå†³ç­–) -> String {
        let mut æ–°é…ç½® = self.é…ç½®.clone();
        æ–°é…ç½®.info.as_mut().unwrap().version =
            Some(format!("{}", Local::now().format("%Y-%m-%d+%H:%M:%S")));
        let mut mapping = IndexMap::new();
        mapping.insert("è¡¥ç -1".into(), Mapped::Basic(è§£.è¡¥ç é”®.into()));
        mapping.insert("ä¸»æ ¹-1".into(), Mapped::Basic(è§£.ç¬¬ä¸€ä¸»æ ¹.into()));
        mapping.insert("ä¸»æ ¹-2".into(), Mapped::Basic(è§£.ç¬¬äºŒä¸»æ ¹.into()));
        for (å…ƒç´ , å®‰æ’) in è§£.å…ƒç´ .iter().enumerate() {
            let mapped: Mapped = å®‰æ’.to_mapped(&self.æ£±é•œ);
            if mapped != Mapped::Unused(()) {
                mapping.insert(self.æ£±é•œ.æ•°å­—è½¬å…ƒç´ [&å…ƒç´ ].clone(), mapped);
            }
        }
        æ–°é…ç½®.form.mapping = mapping;
        to_string(&æ–°é…ç½®).unwrap()
    }
}

impl å†°é›ªæ¸…éŸµä¸Šä¸‹æ–‡ {
    fn _é‡‡ç”¨å†°é›ªå››æ‹¼å£°æ¯å¸ƒå±€(å†³ç­–: &mut å†°é›ªæ¸…éŸµå†³ç­–, æ£±é•œ: &æ£±é•œ) {
        let å£°æ¯åˆ—è¡¨ = ["å£°-zh", "å£°-ch", "å£°-sh", "å£°-0", "å£°-w", "å£°-y", "å£°-yu"];
        let é”®ä½åˆ—è¡¨ = ['w', 'y', 'v', 'r', 's', 'f', 'k'];
        for (å£°æ¯, é”®ä½) in å£°æ¯åˆ—è¡¨.into_iter().zip(é”®ä½åˆ—è¡¨.into_iter()) {
            let å£°æ¯ = æ£±é•œ.å…ƒç´ è½¬æ•°å­—[å£°æ¯];
            å†³ç­–.å…ƒç´ [å£°æ¯] = å…ƒç´ å®‰æ’::é”®ä½(é”®ä½);
        }
    }

    fn _é‡‡ç”¨æœ‰ç†ç¬”ç”»(å†³ç­–: &mut å†°é›ªæ¸…éŸµå†³ç­–, æ£±é•œ: &æ£±é•œ) {
        let ç¬”ç”»è¯»éŸ³ = [
            ("å£°-h", "éŸµ-eng"),
            ("å£°-sh", "éŸµ-u"),
            ("å£°-p", "éŸµ-ie"),
            ("å£°-d", "éŸµ-ian"),
            ("å£°-zh", "éŸµ-e"),
            ("å£°-zh", "éŸµ-e"),
        ];
        for (ç¬”, (å£°æ¯, éŸµæ¯)) in ç¬”ç”».into_iter().zip(ç¬”ç”»è¯»éŸ³) {
            let ç¬”ç”»æ•°å­— = æ£±é•œ.å…ƒç´ è½¬æ•°å­—[ç¬”];
            å†³ç­–.å…ƒç´ [ç¬”ç”»æ•°å­—] = å…ƒç´ å®‰æ’::å£°æ¯éŸµæ¯ {
                å£°æ¯: æ£±é•œ.å…ƒç´ è½¬æ•°å­—[å£°æ¯],
                éŸµæ¯: æ£±é•œ.å…ƒç´ è½¬æ•°å­—[éŸµæ¯],
            };
        }
    }

    pub fn æ–°å»º(è¾“å…¥: é»˜è®¤è¾“å…¥) -> Result<Self, é”™è¯¯> {
        let å¸ƒå±€ = è¾“å…¥.é…ç½®.form.clone();
        let åŸå§‹å†³ç­– = å¸ƒå±€.mapping;
        let åŸå§‹å†³ç­–ç©ºé—´ = å¸ƒå±€.mapping_space.unwrap();
        let åŸå§‹ä¹±åºç”Ÿæˆå™¨ = å¸ƒå±€.mapping_generator.unwrap();
        let åŸå§‹ä¹±åºç”Ÿæˆå™¨ = åŸå§‹ä¹±åºç”Ÿæˆå™¨[0].clone();
        let mut å…ƒç´ è½¬æ•°å­— = FxHashMap::default();
        let mut æ•°å­—è½¬å…ƒç´  = FxHashMap::default();
        let mut é”®è½¬æ•°å­— = FxHashMap::default();
        let mut æ•°å­—è½¬é”® = FxHashMap::default();
        let mut åºå· = 0;
        for c in å¤§é›†åˆ.into_iter().chain(å°é›†åˆ.into_iter()) {
            åºå· += 1;
            å…ƒç´ è½¬æ•°å­—.insert(c.to_string(), åºå·);
            æ•°å­—è½¬å…ƒç´ .insert(åºå·, c.to_string());
            é”®è½¬æ•°å­—.insert(c, åºå· as u64);
            æ•°å­—è½¬é”®.insert(åºå· as u64, c);
        }
        let æ‰€æœ‰å…ƒç´ : Vec<String> = from_str(&read_to_string("data/rules.yaml").unwrap()).unwrap();
        for å…ƒç´  in &æ‰€æœ‰å…ƒç´  {
            åºå· += 1;
            å…ƒç´ è½¬æ•°å­—.insert(å…ƒç´ .clone(), åºå·);
            æ•°å­—è½¬å…ƒç´ .insert(åºå·, å…ƒç´ .clone());
        }
        let æ£±é•œ = æ£±é•œ {
            é”®è½¬æ•°å­—,
            æ•°å­—è½¬é”®,
            å…ƒç´ è½¬æ•°å­—,
            æ•°å­—è½¬å…ƒç´ ,
            è¿›åˆ¶: è¿›åˆ¶ as u64,
        };

        let mut ä¸‹æ¸¸å­—æ ¹: FxHashMap<å…ƒç´ , Vec<_>> = FxHashMap::default();
        let æœ€å¤§æ•°é‡ = æ£±é•œ.æ•°å­—è½¬å…ƒç´ .len() + 1;
        let mut å†³ç­–ç©ºé—´ = å†°é›ªæ¸…éŸµå†³ç­–ç©ºé—´ {
            å…ƒç´ : vec![vec![]; æœ€å¤§æ•°é‡],
            å£°æ¯: vec![],
            éŸµæ¯: vec![],
            å­—æ ¹: vec![],
        };
        let Mapped::Basic(è¡¥ç é”®) = åŸå§‹å†³ç­–["è¡¥ç -1"].clone() else {
            panic!("è¡¥ç é”®å¿…é¡»æŒ‡å®š");
        };
        let Mapped::Basic(ç¬¬ä¸€ä¸»æ ¹) = åŸå§‹å†³ç­–["ä¸»æ ¹-1"].clone() else {
            panic!("ç¬¬ä¸€ä¸»æ ¹å¿…é¡»æŒ‡å®š");
        };
        let Mapped::Basic(ç¬¬äºŒä¸»æ ¹) = åŸå§‹å†³ç­–["ä¸»æ ¹-2"].clone() else {
            panic!("ç¬¬äºŒä¸»æ ¹å¿…é¡»æŒ‡å®š");
        };
        let mut åˆå§‹å†³ç­– = å†°é›ªæ¸…éŸµå†³ç­– {
            å…ƒç´ : vec![å…ƒç´ å®‰æ’::æœªé€‰å–; æœ€å¤§æ•°é‡],
            è¡¥ç é”®: è¡¥ç é”®.chars().next().unwrap(),
            ç¬¬ä¸€ä¸»æ ¹: ç¬¬ä¸€ä¸»æ ¹.chars().next().unwrap(),
            ç¬¬äºŒä¸»æ ¹: ç¬¬äºŒä¸»æ ¹.chars().next().unwrap(),
        };
        for å…ƒç´  in &æ‰€æœ‰å…ƒç´  {
            let åºå· = æ£±é•œ.å…ƒç´ è½¬æ•°å­—[å…ƒç´ ];
            let ç¼–ç  = åŸå§‹å†³ç­–.get(å…ƒç´ ).unwrap_or(&Mapped::Unused(()));
            if ["è¡¥ç -1", "ä¸»æ ¹-1", "ä¸»æ ¹-2"].contains(&å…ƒç´ .as_str()) {
                continue;
            }
            if å…ƒç´ .starts_with("å£°") {
                å†³ç­–ç©ºé—´.å£°æ¯.push(åºå·);
                let Mapped::Basic(ç¼–ç ) = ç¼–ç  else {
                    unreachable!();
                };
                let é”®ä½ = ç¼–ç .chars().next().unwrap();
                åˆå§‹å†³ç­–.å…ƒç´ [åºå·] = å…ƒç´ å®‰æ’::é”®ä½(é”®ä½);
                match å…ƒç´ .as_str() {
                    "å£°-zh" | "å£°-ch" | "å£°-sh" | "å£°-0" => {
                        å†³ç­–ç©ºé—´.å…ƒç´ [åºå·] = å¤§é›†åˆ
                            .into_iter()
                            .filter(|&c| !ä¸å¥½çš„å¤§é›†åˆé”®.contains(&c))
                            .map(|é”®ä½| å…ƒç´ å®‰æ’::é”®ä½(é”®ä½).into())
                            .collect();
                    }
                    _ => {
                        å†³ç­–ç©ºé—´.å…ƒç´ [åºå·] = vec![åˆå§‹å†³ç­–.å…ƒç´ [åºå·].clone().into()];
                    }
                }
            } else if å…ƒç´ .starts_with("éŸµ") {
                å†³ç­–ç©ºé—´.éŸµæ¯.push(åºå·);
                if let Mapped::Grouped { element } = ç¼–ç .clone() {
                    åˆå§‹å†³ç­–.å…ƒç´ [åºå·] = å…ƒç´ å®‰æ’::å½’å¹¶(æ£±é•œ.å…ƒç´ è½¬æ•°å­—[&element]);
                    å†³ç­–ç©ºé—´.å…ƒç´ [åºå·] = vec![åˆå§‹å†³ç­–.å…ƒç´ [åºå·].clone().into()];
                } else {
                    let Mapped::Basic(ç¼–ç ) = ç¼–ç  else {
                        println!("å…ƒç´  {} çš„ç¼–ç ä¸æ˜¯ Basic æˆ– Grouped", å…ƒç´ );
                        unreachable!();
                    };
                    let é”®ä½ = ç¼–ç .chars().next().unwrap();
                    åˆå§‹å†³ç­–.å…ƒç´ [åºå·] = å…ƒç´ å®‰æ’::é”®ä½(é”®ä½);
                    match å…ƒç´ .as_str() {
                        "éŸµ-a" | "éŸµ-e" | "éŸµ-i" | "éŸµ-o" | "éŸµ-u" => {
                            å†³ç­–ç©ºé—´.å…ƒç´ [åºå·] = vec![åˆå§‹å†³ç­–.å…ƒç´ [åºå·].clone().into()];
                        }
                        "éŸµ-an" | "éŸµ-en" | "éŸµ-ang" | "éŸµ-eng" => {
                            å†³ç­–ç©ºé—´.å…ƒç´ [åºå·] = [';', ',', '.', '/']
                                .into_iter()
                                .map(|é”®ä½| å…ƒç´ å®‰æ’::é”®ä½(é”®ä½).into())
                                .collect();
                        }
                        _ => {
                            å†³ç­–ç©ºé—´.å…ƒç´ [åºå·] = ['a', 'e', 'i', 'o', 'u']
                                .into_iter()
                                .map(|é”®ä½| {
                                    if å…ƒç´  == "éŸµ-Ã¼" && é”®ä½ == 'u' {
                                        æ¡ä»¶å…ƒç´ å®‰æ’ {
                                            å®‰æ’: å…ƒç´ å®‰æ’::é”®ä½(é”®ä½),
                                            æ¡ä»¶åˆ—è¡¨: vec![],
                                            æ‰“åˆ†: -1.0,
                                        }
                                    } else {
                                        å…ƒç´ å®‰æ’::é”®ä½(é”®ä½).into()
                                    }
                                })
                                .collect();
                        }
                    }
                }
            } else {
                å†³ç­–ç©ºé—´.å­—æ ¹.push(åºå·);
                let mut åŸå§‹å®‰æ’åˆ—è¡¨ = åŸå§‹å†³ç­–ç©ºé—´.get(å…ƒç´ ).cloned().unwrap_or(vec![]);
                let å½“å‰å†³ç­– = åŸå§‹å†³ç­–.get(å…ƒç´ ).unwrap_or(&Mapped::Unused(()));
                let å½“å‰å†³ç­–ä¸ºä¹±åº = if let Mapped::Advanced(v) = å½“å‰å†³ç­– {
                    if let MappedKey::Ascii(_) = v[0] {
                        true
                    } else {
                        false
                    }
                } else {
                    false
                };
                if !å½“å‰å†³ç­–ä¸ºä¹±åº && !åŸå§‹å®‰æ’åˆ—è¡¨.iter().any(|x| &x.value == å½“å‰å†³ç­–)
                {
                    åŸå§‹å®‰æ’åˆ—è¡¨.insert(
                        0,
                        ValueDescription {
                            value: å½“å‰å†³ç­–.clone(),
                            score: 0.0,
                            condition: None,
                        },
                    );
                }
                let mut å®‰æ’åˆ—è¡¨ = vec![];
                for åŸå§‹å®‰æ’ in &åŸå§‹å®‰æ’åˆ—è¡¨ {
                    let å­—æ ¹å®‰æ’ = å…ƒç´ å®‰æ’::from(&åŸå§‹å®‰æ’.value, &æ£±é•œ);
                    let mut åŸå§‹æ¡ä»¶ = åŸå§‹å®‰æ’.condition.clone().unwrap_or_default();
                    let å½’å¹¶å­—æ ¹ = if let å…ƒç´ å®‰æ’::å½’å¹¶(å­—æ ¹) = &å­—æ ¹å®‰æ’ {
                        Some(å­—æ ¹.clone())
                    } else if let å…ƒç´ å®‰æ’::å½’å¹¶éŸµæ¯ { å­—æ ¹, .. } = &å­—æ ¹å®‰æ’ {
                        Some(å­—æ ¹.clone())
                    } else {
                        None
                    };
                    if let Some(å½’å¹¶å­—æ ¹) = å½’å¹¶å­—æ ¹ {
                        let é»˜è®¤æ¡ä»¶ = Condition {
                            element: æ£±é•œ.æ•°å­—è½¬å…ƒç´ [&å½’å¹¶å­—æ ¹].clone(),
                            op: "ä¸æ˜¯".to_string(),
                            value: Mapped::Unused(()),
                        };
                        if !åŸå§‹æ¡ä»¶.iter().any(|x| x == &é»˜è®¤æ¡ä»¶) {
                            åŸå§‹æ¡ä»¶.push(é»˜è®¤æ¡ä»¶);
                        }
                    }
                    let æ¡ä»¶åˆ—è¡¨: Vec<æ¡ä»¶> = åŸå§‹æ¡ä»¶
                        .into_iter()
                        .map(|c| æ¡ä»¶ {
                            å…ƒç´ : æ£±é•œ.å…ƒç´ è½¬æ•°å­—[&c.element],
                            è°“è¯: c.op == "æ˜¯",
                            å€¼: å…ƒç´ å®‰æ’::from(&c.value, &æ£±é•œ),
                        })
                        .collect();
                    for æ¡ä»¶ in &æ¡ä»¶åˆ—è¡¨ {
                        if ä¸‹æ¸¸å­—æ ¹.contains_key(&æ¡ä»¶.å…ƒç´ ) {
                            if !ä¸‹æ¸¸å­—æ ¹[&æ¡ä»¶.å…ƒç´ ].contains(&åºå·) {
                                ä¸‹æ¸¸å­—æ ¹.get_mut(&æ¡ä»¶.å…ƒç´ ).unwrap().push(åºå·);
                            }
                        } else {
                            ä¸‹æ¸¸å­—æ ¹.insert(æ¡ä»¶.å…ƒç´ .clone(), vec![åºå·]);
                        }
                    }
                    let æ¡ä»¶å­—æ ¹å®‰æ’ = æ¡ä»¶å…ƒç´ å®‰æ’ {
                        å®‰æ’: å­—æ ¹å®‰æ’,
                        æ¡ä»¶åˆ—è¡¨,
                        æ‰“åˆ†: åŸå§‹å®‰æ’.score,
                    };
                    å®‰æ’åˆ—è¡¨.push(æ¡ä»¶å­—æ ¹å®‰æ’);
                }
                // ç¬¬ä¸€ä¸»æ ¹
                if ç¬”ç”».contains(&å…ƒç´ .as_str()) {
                    for é”®ä½ in å¤§é›†åˆ {
                        let å®‰æ’ = å…ƒç´ å®‰æ’::é”®ä½ç¬¬ä¸€(é”®ä½);
                        if å®‰æ’åˆ—è¡¨.iter().any(|x| x.å®‰æ’ == å®‰æ’) {
                            continue;
                        }
                        if å…ƒç´  == "1" && !['d', 'f', 'j', 'k'].contains(&é”®ä½) {
                            continue;
                        }
                        å®‰æ’åˆ—è¡¨.push(æ¡ä»¶å…ƒç´ å®‰æ’ {
                            å®‰æ’,
                            æ¡ä»¶åˆ—è¡¨: vec![],
                            æ‰“åˆ†: 0.0,
                        });
                    }
                }
                // ç¬¬äºŒä¸»æ ¹
                if åŸå§‹ä¹±åºç”Ÿæˆå™¨.elements.contains(&å…ƒç´ ) {
                    let æ¡ä»¶åˆ—è¡¨ = å®‰æ’åˆ—è¡¨
                        .iter()
                        .find(|x| matches!(x.å®‰æ’, å…ƒç´ å®‰æ’::å£°æ¯éŸµæ¯ { .. }))
                        .map(|x| &x.æ¡ä»¶åˆ—è¡¨)
                        .unwrap_or(&vec![])
                        .clone();
                    for é”®ä½ in å¤§é›†åˆ {
                        let å®‰æ’ = å…ƒç´ å®‰æ’::é”®ä½ç¬¬äºŒ(é”®ä½);
                        if å®‰æ’åˆ—è¡¨.iter().any(|x| {
                            if x.å®‰æ’ == å®‰æ’ {
                                true
                            } else if let å…ƒç´ å®‰æ’::å£°æ¯éŸµæ¯ { å£°æ¯, .. } = x.å®‰æ’ {
                                åˆå§‹å†³ç­–.å…ƒç´ [å£°æ¯] == å…ƒç´ å®‰æ’::é”®ä½(é”®ä½)
                            } else {
                                false
                            }
                        }) {
                            continue;
                        }
                        å®‰æ’åˆ—è¡¨.push(æ¡ä»¶å…ƒç´ å®‰æ’ {
                            å®‰æ’,
                            æ¡ä»¶åˆ—è¡¨: æ¡ä»¶åˆ—è¡¨.clone(),
                            æ‰“åˆ†: 0.0,
                        });
                    }
                }
                let å®‰æ’åˆ—è¡¨: Vec<_> = å®‰æ’åˆ—è¡¨.into_iter().collect();
                åˆå§‹å†³ç­–.å…ƒç´ [åºå·] = å…ƒç´ å®‰æ’::from(å½“å‰å†³ç­–, &æ£±é•œ);
                å†³ç­–ç©ºé—´.å…ƒç´ [åºå·] = å®‰æ’åˆ—è¡¨;
            }
        }

        let mut æ‰€æœ‰ç¬¬ä¸€ä¸»æ ¹é”®ä½ = vec![];
        let mut æ‰€æœ‰ç¬¬äºŒä¸»æ ¹é”®ä½ = vec![];
        for å®‰æ’ in åˆå§‹å†³ç­–.å…ƒç´ .iter() {
            if let å…ƒç´ å®‰æ’::é”®ä½ç¬¬ä¸€(é”®ä½) = å®‰æ’ {
                æ‰€æœ‰ç¬¬ä¸€ä¸»æ ¹é”®ä½.push(*é”®ä½);
            } else if let å…ƒç´ å®‰æ’::é”®ä½ç¬¬äºŒ(é”®ä½) = å®‰æ’ {
                æ‰€æœ‰ç¬¬äºŒä¸»æ ¹é”®ä½.push(*é”®ä½);
            }
        }
        assert!(
            æ‰€æœ‰ç¬¬ä¸€ä¸»æ ¹é”®ä½.len() == 6,
            "åˆå§‹å†³ç­–ä¸­çš„ä¹±åºé”®ä½ä¸å®Œæ•´: {æ‰€æœ‰ç¬¬ä¸€ä¸»æ ¹é”®ä½:?}"
        );
        assert!(
            æ‰€æœ‰ç¬¬äºŒä¸»æ ¹é”®ä½.len() == 21 && å¤§é›†åˆ.iter().all(|c| æ‰€æœ‰ç¬¬äºŒä¸»æ ¹é”®ä½.contains(&c)),
            "åˆå§‹å†³ç­–ä¸­çš„ä¹±åºé”®ä½ä¸å®Œæ•´: {æ‰€æœ‰ç¬¬äºŒä¸»æ ¹é”®ä½:?}"
        );

        let (å›ºå®šæ‹†åˆ†, åŠ¨æ€æ‹†åˆ†, å—è½¬æ•°å­—, æ•°å­—è½¬å—, ç®€ä½“é¡ºåº, ç¹ä½“é¡ºåº) =
            Self::è§£æåŠ¨æ€æ‹†åˆ†(&æ£±é•œ, &å†³ç­–ç©ºé—´);
        let æ‹¼éŸ³ = Self::è¯»å–æ‹¼éŸ³(&æ£±é•œ);
        Ok(Self {
            é…ç½®: è¾“å…¥.é…ç½®,
            æ£±é•œ,
            åˆå§‹å†³ç­–,
            å†³ç­–ç©ºé—´,
            åŸå§‹é”®ä½åˆ†å¸ƒä¿¡æ¯: è¾“å…¥.åŸå§‹é”®ä½åˆ†å¸ƒä¿¡æ¯,
            åŸå§‹å½“é‡ä¿¡æ¯: è¾“å…¥.åŸå§‹å½“é‡ä¿¡æ¯,
            å›ºå®šæ‹†åˆ†,
            åŠ¨æ€æ‹†åˆ†,
            å—è½¬æ•°å­—,
            æ•°å­—è½¬å—,
            ç®€ä½“é¡ºåº,
            ç¹ä½“é¡ºåº,
            ä¸‹æ¸¸å­—æ ¹,
            æ‹¼éŸ³,
        })
    }

    pub fn é¢„å¤„ç†å½“é‡ä¿¡æ¯(&self) -> Vec<f32> {
        let mut å½“é‡ä¿¡æ¯ = vec![0.0; ç¼–ç ::ç¼–ç ç©ºé—´å¤§å°()];
        let s = vec![];
        let ç©ºæ ¼1 = ç©ºæ ¼ as u8;
        let è¿›åˆ¶1 = è¿›åˆ¶ as u8;
        for c1 in 0..ç©ºæ ¼1 {
            let mut s1 = s.clone();
            self.æ£±é•œ.æ•°å­—è½¬é”®.get(&(c1 as u64)).map(|z| s1.push(*z));
            for c2 in 0..ç©ºæ ¼1 {
                let mut s2 = s1.clone();
                self.æ£±é•œ.æ•°å­—è½¬é”®.get(&(c2 as u64)).map(|z| s2.push(*z));
                for c3 in 0..ç©ºæ ¼1 {
                    let mut s3 = s2.clone();
                    self.æ£±é•œ.æ•°å­—è½¬é”®.get(&(c3 as u64)).map(|z| s3.push(*z));
                    for c4 in 0..è¿›åˆ¶1 {
                        let mut s4 = s3.clone();
                        self.æ£±é•œ.æ•°å­—è½¬é”®.get(&(c4 as u64)).map(|z| s4.push(*z));
                        let c = [c1, c2, c3, c4].to_usize();
                        for range in [0..2, 1..3, 2..4, 0..3, 1..4, 0..4] {
                            if range.end > s4.len() {
                                continue;
                            }
                            let substr: String = s4[range].iter().collect();
                            å½“é‡ä¿¡æ¯[c as usize] +=
                                *self.åŸå§‹å½“é‡ä¿¡æ¯.get(&substr).unwrap_or(&0.0) as f32;
                        }
                    }
                }
            }
        }
        å½“é‡ä¿¡æ¯
    }

    fn è¯»å–æ‹¼éŸ³(æ£±é•œ: &æ£±é•œ) -> Vec<éŸ³èŠ‚ä¿¡æ¯> {
        let åŸå§‹æ‹¼éŸ³: Vec<åŸå§‹éŸ³èŠ‚ä¿¡æ¯> = è¯»å–æ–‡æœ¬æ–‡ä»¶("data/pinyin.txt".into());
        let mut æ‹¼éŸ³ = Vec::new();
        for åŸå§‹éŸ³èŠ‚ä¿¡æ¯ {
            å£°æ¯, éŸµæ¯, é¢‘ç‡,
        ..
        } in &åŸå§‹æ‹¼éŸ³
        {
            let å£°æ¯ = format!("å£°-{å£°æ¯}");
            let éŸµæ¯ = format!("éŸµ-{éŸµæ¯}");
            if !æ£±é•œ.å…ƒç´ è½¬æ•°å­—.contains_key(&å£°æ¯) {
                panic!("æ‹¼éŸ³å£°æ¯ {} ä¸åœ¨æ£±é•œä¸­", å£°æ¯);
            }
            if !æ£±é•œ.å…ƒç´ è½¬æ•°å­—.contains_key(&éŸµæ¯) {
                panic!("æ‹¼éŸ³éŸµæ¯ {} ä¸åœ¨æ£±é•œä¸­", éŸµæ¯);
            }
            let å£°æ¯ = æ£±é•œ.å…ƒç´ è½¬æ•°å­—[&å£°æ¯];
            let éŸµæ¯ = æ£±é•œ.å…ƒç´ è½¬æ•°å­—[&éŸµæ¯];
            æ‹¼éŸ³.push(éŸ³èŠ‚ä¿¡æ¯ {
                å£°æ¯,
                éŸµæ¯,
                é¢‘ç‡: *é¢‘ç‡ as é¢‘ç‡,
            });
        }
        let æ€»é¢‘ç‡: é¢‘ç‡ = æ‹¼éŸ³.iter().map(|x| x.é¢‘ç‡).sum();
        for éŸ³èŠ‚ in &mut æ‹¼éŸ³ {
            éŸ³èŠ‚.é¢‘ç‡ /= æ€»é¢‘ç‡;
        }
        æ‹¼éŸ³
    }

    fn å¯¹é½(åˆ—è¡¨: Vec<å…ƒç´ >, é»˜è®¤å€¼: å…ƒç´ ) -> [å…ƒç´ ; 4] {
        [0, 1, 2, 3].map(|i| {
            if i == 3 && åˆ—è¡¨.len() > 3 {
                åˆ—è¡¨[åˆ—è¡¨.len() - 1]
            } else if i < åˆ—è¡¨.len() {
                åˆ—è¡¨[i]
            } else {
                é»˜è®¤å€¼
            }
        })
    }

    pub fn è§£æåŠ¨æ€æ‹†åˆ†(
        æ£±é•œ: &æ£±é•œ,
        å†³ç­–ç©ºé—´: &å†°é›ªæ¸…éŸµå†³ç­–ç©ºé—´,
    ) -> (
        Vec<å›ºå®šæ‹†åˆ†é¡¹>,
        Vec<åŠ¨æ€æ‹†åˆ†é¡¹>,
        FxHashMap<String, usize>,
        FxHashMap<usize, String>,
        Vec<usize>,
        Vec<usize>,
    ) {
        let æ‹†åˆ†è¾“å…¥: æ‹†åˆ†è¾“å…¥ =
            from_str(&read_to_string("data/dynamic_analysis.yaml").unwrap()).unwrap();
        let ç¹ä½“å­—é¢‘: FxHashMap<char, u64> = è¯»å–æ–‡æœ¬æ–‡ä»¶(PathBuf::from("data/ftzp.txt"));
        let é™†æ ‡è½¬å°æ ‡: FxHashMap<char, char> = è¯»å–æ–‡æœ¬æ–‡ä»¶(PathBuf::from("data/t2tw.txt"));
        let mut åŠ¨æ€æ‹†åˆ† = vec![];
        let mut å—è½¬æ•°å­— = FxHashMap::default();
        let mut æ•°å­—è½¬å— = FxHashMap::default();
        for (å—, åŸå§‹æ‹†åˆ†æ–¹å¼åˆ—è¡¨) in æ‹†åˆ†è¾“å…¥.åŠ¨æ€æ‹†åˆ† {
            let å—åºå· = åŠ¨æ€æ‹†åˆ†.len();
            å—è½¬æ•°å­—.insert(å—.clone(), å—åºå·);
            æ•°å­—è½¬å—.insert(å—åºå·, å—.clone());
            let mut æ‹†åˆ†æ–¹å¼åˆ—è¡¨ = vec![];
            for åŸå§‹æ‹†åˆ†æ–¹å¼ in &åŸå§‹æ‹†åˆ†æ–¹å¼åˆ—è¡¨ {
                for æ‹†åˆ†æ–¹å¼ in åŸå§‹æ‹†åˆ†æ–¹å¼ {
                    assert!(
                        æ£±é•œ.å…ƒç´ è½¬æ•°å­—.contains_key(æ‹†åˆ†æ–¹å¼),
                        "å…ƒç´  {} ä¸åœ¨æ£±é•œä¸­",
                        æ‹†åˆ†æ–¹å¼
                    );
                }
                let æ‹†åˆ†æ–¹å¼ = Self::å¯¹é½(
                    åŸå§‹æ‹†åˆ†æ–¹å¼
                        .iter()
                        .map(|å­—æ ¹| æ£±é•œ.å…ƒç´ è½¬æ•°å­—[å­—æ ¹])
                        .collect(),
                    0,
                );
                æ‹†åˆ†æ–¹å¼åˆ—è¡¨.push(æ‹†åˆ†æ–¹å¼);
            }
            // æ£€æŸ¥åŸå§‹æ‹†åˆ†æ–¹å¼åˆ—è¡¨çš„æœ€åä¸€é¡¹éƒ½æ˜¯å¿…é€‰å­—æ ¹
            let æœ€åä¸€é¡¹ = åŸå§‹æ‹†åˆ†æ–¹å¼åˆ—è¡¨.last().unwrap();
            if !æœ€åä¸€é¡¹.iter().all(|x| {
                !å†³ç­–ç©ºé—´.å…ƒç´ [æ£±é•œ.å…ƒç´ è½¬æ•°å­—[x]]
                    .iter()
                    .any(|x| x.å®‰æ’ == å…ƒç´ å®‰æ’::æœªé€‰å–)
            }) {
                panic!("åŠ¨æ€æ‹†åˆ†æ–¹å¼åˆ—è¡¨çš„æœ€åä¸€é¡¹å¿…é¡»éƒ½æ˜¯å¿…é€‰å­—æ ¹, {å—:?}, {åŸå§‹æ‹†åˆ†æ–¹å¼åˆ—è¡¨:?}");
            }
            åŠ¨æ€æ‹†åˆ†.push(æ‹†åˆ†æ–¹å¼åˆ—è¡¨);
        }
        let mut å›ºå®šæ‹†åˆ† = vec![];
        let mut ç®€ä½“æ€»é¢‘æ•°: u64 = 0;
        let mut ç¹ä½“æ€»é¢‘æ•°: u64 = 0;
        let å›½å­—å¸¸ç”¨: FxHashSet<char> = æ‹†åˆ†è¾“å…¥
            .å›ºå®šæ‹†åˆ†
            .iter()
            .filter(|x| x.å›½å­—å¸¸ç”¨)
            .map(|x| x.æ±‰å­—)
            .collect();
        for è¯ in &æ‹†åˆ†è¾“å…¥.å›ºå®šæ‹†åˆ† {
            let å­—å— = Self::å¯¹é½(è¯.æ‹†åˆ†.iter().map(|å—| å—è½¬æ•°å­—[å—]).collect(), usize::MAX);
            let mut ç®€ä½“é¢‘ç‡ = 0.0;
            let mut ç¹ä½“é¢‘ç‡ = 0.0;
            if è¯.gb2312 {
                ç®€ä½“é¢‘ç‡ = è¯.é¢‘ç‡ as é¢‘ç‡;
                ç®€ä½“æ€»é¢‘æ•° += è¯.é¢‘ç‡;
            }
            let mut é™†æ ‡ = false;
            if è¯.å›½å­—å¸¸ç”¨ {
                ç¹ä½“é¢‘ç‡ = *ç¹ä½“å­—é¢‘.get(&è¯.æ±‰å­—).unwrap_or(&0) as é¢‘ç‡;
                ç¹ä½“æ€»é¢‘æ•° += ç¹ä½“é¢‘ç‡ as u64;
            } else {
                if let Some(&å°æ ‡) = é™†æ ‡è½¬å°æ ‡.get(&è¯.æ±‰å­—) {
                    if å›½å­—å¸¸ç”¨.contains(&å°æ ‡) {
                        ç¹ä½“é¢‘ç‡ = *ç¹ä½“å­—é¢‘.get(&å°æ ‡).unwrap_or(&0) as é¢‘ç‡;
                        ç¹ä½“æ€»é¢‘æ•° += ç¹ä½“é¢‘ç‡ as u64;
                        é™†æ ‡ = true;
                    }
                }
            }
            å›ºå®šæ‹†åˆ†.push(å›ºå®šæ‹†åˆ†é¡¹ {
                è¯: è¯.æ±‰å­—,
                ç®€ä½“é¢‘ç‡,
                ç®€ä½“é¢‘åº: é¢‘åº::MAX,
                ç¹ä½“é¢‘ç‡,
                ç¹ä½“é¢‘åº: é¢‘åº::MAX,
                é€šæ‰“é¢‘ç‡: 0.0,
                å­—å—,
                é€šè§„: è¯.é€šè§„ > 0,
                gb2312: è¯.gb2312,
                å›½å­—å¸¸ç”¨: è¯.å›½å­—å¸¸ç”¨,
                é™†æ ‡,
            });
        }
        // å½’ä¸€åŒ–é¢‘ç‡
        for é¡¹ in &mut å›ºå®šæ‹†åˆ† {
            é¡¹.ç®€ä½“é¢‘ç‡ /= ç®€ä½“æ€»é¢‘æ•° as é¢‘ç‡;
            é¡¹.ç¹ä½“é¢‘ç‡ /= ç¹ä½“æ€»é¢‘æ•° as é¢‘ç‡;
            é¡¹.é€šæ‰“é¢‘ç‡ = (é¡¹.ç®€ä½“é¢‘ç‡ + é¡¹.ç¹ä½“é¢‘ç‡) / 2.0;
        }
        å›ºå®šæ‹†åˆ†.sort_by(|a, b| {
            b.é€šæ‰“é¢‘ç‡
                .partial_cmp(&a.é€šæ‰“é¢‘ç‡)
                .unwrap()
                .then_with(|| (b.å›½å­—å¸¸ç”¨ || b.é™†æ ‡).cmp(&(a.å›½å­—å¸¸ç”¨ || a.é™†æ ‡)))
                .then_with(|| (b.gb2312).cmp(&(a.gb2312)))
        });
        for i in 0..å¸¸ç”¨ç®€ç¹èŒƒå›´ {
            assert!(
                å›ºå®šæ‹†åˆ†[i].gb2312 || å›ºå®šæ‹†åˆ†[i].å›½å­—å¸¸ç”¨ || å›ºå®šæ‹†åˆ†[i].é™†æ ‡,
                "å‰ {} ä¸ªå­—ä¸­ç¬¬ {} ä¸ªå­—æ—¢ä¸æ˜¯ç®€ä½“å¸¸ç”¨å­—ä¹Ÿä¸æ˜¯ç¹ä½“å¸¸ç”¨å­—: {:?}",
                å¸¸ç”¨ç®€ç¹èŒƒå›´,
                i + 1,
                å›ºå®šæ‹†åˆ†[i]
            );
        }
        for i in å¸¸ç”¨ç®€ç¹èŒƒå›´..å›ºå®šæ‹†åˆ†.len() {
            assert!(
                !å›ºå®šæ‹†åˆ†[i].gb2312 && !å›ºå®šæ‹†åˆ†[i].å›½å­—å¸¸ç”¨ && !å›ºå®šæ‹†åˆ†[i].é™†æ ‡,
                "ç¬¬ {} ä¸ªå­—æ˜¯ç®€ä½“æˆ–ç¹ä½“å¸¸ç”¨å­—: {:?}",
                i + 1,
                å›ºå®šæ‹†åˆ†[i]
            );
        }
        let ç®€ä½“é¡ºåº: Vec<_> = å›ºå®šæ‹†åˆ†
            .iter()
            .enumerate()
            .filter(|(_, x)| x.gb2312)
            .sorted_by(|(_, a), (_, b)| b.ç®€ä½“é¢‘ç‡.partial_cmp(&a.ç®€ä½“é¢‘ç‡).unwrap())
            .map(|(i, _)| i)
            .collect();
        let ç¹ä½“é¡ºåº: Vec<_> = å›ºå®šæ‹†åˆ†
            .iter()
            .enumerate()
            .filter(|(_, x)| x.å›½å­—å¸¸ç”¨ || x.é™†æ ‡)
            .sorted_by(|(_, a), (_, b)| b.ç¹ä½“é¢‘ç‡.partial_cmp(&a.ç¹ä½“é¢‘ç‡).unwrap())
            .map(|(i, _)| i)
            .collect();
        for (ç®€ä½“é¢‘åº, ç´¢å¼•) in ç®€ä½“é¡ºåº.iter().enumerate() {
            å›ºå®šæ‹†åˆ†[*ç´¢å¼•].ç®€ä½“é¢‘åº = ç®€ä½“é¢‘åº as é¢‘åº;
        }
        for (ç¹ä½“é¢‘åº, ç´¢å¼•) in ç¹ä½“é¡ºåº.iter().enumerate() {
            å›ºå®šæ‹†åˆ†[*ç´¢å¼•].ç¹ä½“é¢‘åº = ç¹ä½“é¢‘åº as é¢‘åº;
        }
        (å›ºå®šæ‹†åˆ†, åŠ¨æ€æ‹†åˆ†, å—è½¬æ•°å­—, æ•°å­—è½¬å—, ç®€ä½“é¡ºåº, ç¹ä½“é¡ºåº)
    }

    fn è½¬ç¼–ç (&self, code: ç¼–ç ) -> String {
        code.iter()
            .filter_map(|x| self.æ£±é•œ.æ•°å­—è½¬é”®.get(&(*x as u64)))
            .cloned()
            .collect()
    }

    fn æ’åºç¼–ç (&self, res: &Vec<Regex>, code: &String) -> (usize, usize, Vec<usize>) {
        let order = "bpmfdtnlgkhjqxzcsrvwyaoeiu;,./";
        let mut category = usize::MAX;
        for (index, re) in res.iter().enumerate() {
            if re.is_match(code) {
                category = index;
                break;
            }
        }
        let length = code.len();
        let orders = code
            .chars()
            .map(|c| order.find(c).unwrap_or(usize::MAX))
            .collect();
        (category, length, orders)
    }

    pub fn ç”Ÿæˆç è¡¨(&self, ç¼–ç ç»“æœ: &[å†°é›ªæ¸…éŸµç¼–ç ä¿¡æ¯], ç›®å½•: Option<PathBuf>) {
        let ç›®å½• = ç›®å½•.unwrap_or_else(|| PathBuf::from("output"));
        let mut å®‡æµ©æµ‹è¯„ç è¡¨ = Vec::new();
        let mut å¤§ç«¹ç è¡¨ = Vec::new();
        let mut å½¢ç ç›’å­æµ‹è¯„ç è¡¨ = Vec::new();
        let mut æœªæ’åºå›ºæ€è¯å…¸ç è¡¨ = FxHashMap::default();
        for (å¯ç¼–ç å¯¹è±¡, ç¼–ç ä¿¡æ¯) in self
            .å›ºå®šæ‹†åˆ†
            .iter()
            .zip(ç¼–ç ç»“æœ)
            .sorted_by_key(|(_, x)| x.ç®€ä½“é¢‘åº)
        {
            let å…¨ç  = self.è½¬ç¼–ç (ç¼–ç ä¿¡æ¯.è®¡é‡å…¨ç );
            let æ— ç©ºæ ¼å…¨ç  = å…¨ç .replace("_", "");
            let å¸¦ç©ºæ ¼å…¨ç  = å…¨ç .replace("_", " ");
            let ç®€ç  = self.è½¬ç¼–ç (ç¼–ç ä¿¡æ¯.ç®€ä½“ç®€ç );
            let æ— ç©ºæ ¼ç®€ç  = ç®€ç .replace("_", "");
            let å¸¦ç©ºæ ¼ç®€ç  = ç®€ç .replace("_", " ");
            å®‡æµ©æµ‹è¯„ç è¡¨.push((å¯ç¼–ç å¯¹è±¡.è¯, æ— ç©ºæ ¼å…¨ç .clone()));
            å¤§ç«¹ç è¡¨.push((å…¨ç .clone(), å¯ç¼–ç å¯¹è±¡.è¯.to_string()));
            å½¢ç ç›’å­æµ‹è¯„ç è¡¨.push((å¯ç¼–ç å¯¹è±¡.è¯, å¸¦ç©ºæ ¼å…¨ç .clone()));
            æœªæ’åºå›ºæ€è¯å…¸ç è¡¨
                .entry(æ— ç©ºæ ¼å…¨ç .clone())
                .or_insert_with(Vec::new)
                .push(å¯ç¼–ç å¯¹è±¡.è¯.to_string());
            if !æ— ç©ºæ ¼ç®€ç .is_empty() && æ— ç©ºæ ¼ç®€ç  != æ— ç©ºæ ¼å…¨ç  {
                å®‡æµ©æµ‹è¯„ç è¡¨.push((å¯ç¼–ç å¯¹è±¡.è¯, æ— ç©ºæ ¼ç®€ç .clone()));
                å¤§ç«¹ç è¡¨.push((ç®€ç .clone(), å¯ç¼–ç å¯¹è±¡.è¯.to_string()));
                å½¢ç ç›’å­æµ‹è¯„ç è¡¨.push((å¯ç¼–ç å¯¹è±¡.è¯, å¸¦ç©ºæ ¼ç®€ç .clone()));
                if self.è½¬ç¼–ç (ç¼–ç ä¿¡æ¯.ç®€ä½“ç®€ç ).len() > 1 {
                    æœªæ’åºå›ºæ€è¯å…¸ç è¡¨
                        .entry(æ— ç©ºæ ¼ç®€ç .clone())
                        .or_insert_with(Vec::new)
                        .push(å¯ç¼–ç å¯¹è±¡.è¯.to_string());
                }
            }
        }
        let æ‹†åˆ†ç»“æœ: Vec<(String, String)> =
            è¯»å–æ–‡æœ¬æ–‡ä»¶(PathBuf::from("data/æ‹†åˆ†ç»“æœ.txt"));
        for (å­—, æ‹†åˆ†) in æ‹†åˆ†ç»“æœ {
            å¤§ç«¹ç è¡¨.push((format!("æ‹†åˆ†ï¼»{}ï¼½", æ‹†åˆ†.clone()), å­—));
        }
        self.åå¤„ç†å›ºæ€è¯å…¸ç è¡¨(&mut æœªæ’åºå›ºæ€è¯å…¸ç è¡¨, &mut å¤§ç«¹ç è¡¨);
        let re1 = Regex::new(r"^[bpmfdtnlgkhjqxzcsrvwy]$").unwrap();
        let re2 = Regex::new(r"^[bpmfdtnlgkhjqxzcsrvwy][aoeiu;,./]$").unwrap();
        let re3 = Regex::new(r"^[bpmfdtnlgkhjqxzcsrvwy]{2}$").unwrap();
        let re4 = Regex::new(r"^[bpmfdtnlgkhjqxzcsrvwy]{2}[aoeiu;,./]$").unwrap();
        let re5 = Regex::new(r"^[bpmfdtnlgkhjqxzcsrvwy]{3}$").unwrap();
        let re6 = Regex::new(r"^[bpmfdtnlgkhjqxzcsrvwy]{3}[aoeiu;,./]$").unwrap();
        let re7 = Regex::new(r"^[bpmfdtnlgkhjqxzcsrvwy]{4}$").unwrap();
        let res = vec![re1, re2, re3, re4, re5, re6, re7];
        let å›ºæ€è¯å…¸ç è¡¨: Vec<_> = æœªæ’åºå›ºæ€è¯å…¸ç è¡¨
            .into_iter()
            .sorted_by_key(|(ç¼–ç å­—ç¬¦ä¸², _)| self.æ’åºç¼–ç (&res, &ç¼–ç å­—ç¬¦ä¸²))
            .map(|(å­—ç¬¦ä¸², è¯åˆ—è¡¨)| (å­—ç¬¦ä¸², è¯åˆ—è¡¨.join(" ")))
            .collect();
        å†™å…¥æ–‡æœ¬æ–‡ä»¶(ç›®å½•.join("å†°é›ªæ¸…éŸµ.txt"), å®‡æµ©æµ‹è¯„ç è¡¨);
        å†™å…¥æ–‡æœ¬æ–‡ä»¶(ç›®å½•.join("å¤§ç«¹ç è¡¨.txt"), å¤§ç«¹ç è¡¨);
        å†™å…¥æ–‡æœ¬æ–‡ä»¶(ç›®å½•.join("å½¢ç ç›’å­æµ‹è¯„ç è¡¨.txt"), å½¢ç ç›’å­æµ‹è¯„ç è¡¨);
        å†™å…¥æ–‡æœ¬æ–‡ä»¶(ç›®å½•.join("snow_qingyun.fixed.txt"), å›ºæ€è¯å…¸ç è¡¨);
    }

    pub fn åå¤„ç†å›ºæ€è¯å…¸ç è¡¨(
        &self,
        å›ºæ€è¯å…¸ç è¡¨: &mut FxHashMap<String, Vec<String>>,
        å¤§ç«¹ç è¡¨: &mut Vec<(String, String)>,
    ) {
        let ç®€ç è¦†ç›–: ç®€ç è¦†ç›– = from_str(&read_to_string("data/override.yaml").unwrap()).unwrap();
        for (ç®€è¯, ç¼–ç ) in ç®€ç è¦†ç›–.ç®€è¯å¿«ç¬¦ {
            å›ºæ€è¯å…¸ç è¡¨.insert(ç¼–ç .clone(), vec![ç®€è¯.clone()]);
            å¤§ç«¹ç è¡¨.push((ç¼–ç .clone(), ç®€è¯.clone()));
        }
        let æ•°å­—ä¿¡æ¯ = [
            ('1', 'ä¸€', "yi"),
            ('2', 'äºŒ', "vi"),
            ('3', 'ä¸‰', "s;"),
            ('4', 'å››', "si"),
            ('5', 'äº”', "wu"),
            ('6', 'å…­', "la"),
            ('7', 'ä¸ƒ', "qi"),
            ('8', 'å…«', "ba"),
            ('9', 'ä¹', "ja"),
            ('0', 'é›¶', "l/"),
        ];
        for (æ•°å­—, æ±‰å­—, ç¼–ç ) in æ•°å­—ä¿¡æ¯ {
            let æ¡ç›® = &mut å›ºæ€è¯å…¸ç è¡¨
                .entry(ç¼–ç .to_string())
                .or_insert_with(Vec::new);
            æ¡ç›®.push(æ•°å­—.to_string());
            æ¡ç›®.push(æ±‰å­—.to_string());
        }

        for key in "bpmfdtnlgkhjqxzcsrvwy".chars() {
            let ç¼–ç  = format!("{}.", key);
            let æ¡ç›® = &mut å›ºæ€è¯å…¸ç è¡¨.entry(ç¼–ç .clone()).or_insert_with(Vec::new);
            if æ¡ç›®.is_empty() {
                æ¡ç›®.push("ğŸˆšï¸".to_string());
            }
            æ¡ç›®.push(key.to_uppercase().to_string());
            æ¡ç›®.push(key.to_string());
        }
        for key in "aoeiu".chars() {
            let ç¼–ç  = format!("m{}", key);
            let æ¡ç›® = &mut å›ºæ€è¯å…¸ç è¡¨.entry(ç¼–ç .clone()).or_insert_with(Vec::new);
            æ¡ç›®.push(key.to_uppercase().to_string());
            æ¡ç›®.push(key.to_string());
        }
    }

    pub fn ç¿»è½¬ç è¡¨(
        &self,
        ç¼–ç ç»“æœ: &[å†°é›ªæ¸…éŸµç¼–ç ä¿¡æ¯],
        é¡ºåº: &Vec<usize>,
        é¢‘ç‡: &impl Fn(&å†°é›ªæ¸…éŸµç¼–ç ä¿¡æ¯) -> é¢‘ç‡,
    ) -> Vec<(ç¼–ç , Vec<char>, é¢‘ç‡)> {
        let mut ç¿»è½¬ç è¡¨ = FxHashMap::default();
        let mut é‡ç ç»„åˆ—è¡¨ = vec![];
        for ç´¢å¼• in é¡ºåº {
            ç¿»è½¬ç è¡¨
                .entry(ç¼–ç ç»“æœ[*ç´¢å¼•].è®¡é‡å…¨ç )
                .or_insert_with(|| vec![])
                .push((self.å›ºå®šæ‹†åˆ†[*ç´¢å¼•].è¯, é¢‘ç‡(&ç¼–ç ç»“æœ[*ç´¢å¼•])));
        }
        for (å…¨ç , é‡ç ç»„) in ç¿»è½¬ç è¡¨ {
            if é‡ç ç»„.len() > 1 {
                let æ€»é¢‘ç‡: é¢‘ç‡ = é‡ç ç»„[1..].iter().map(|x| x.1).sum();
                é‡ç ç»„åˆ—è¡¨.push((å…¨ç , é‡ç ç»„.iter().map(|x| x.0).collect(), æ€»é¢‘ç‡));
            }
        }
        é‡ç ç»„åˆ—è¡¨.sort_by_key(|(_, _, é¢‘ç‡)| std::cmp::Reverse((*é¢‘ç‡ * 1_000_000.0) as u64));
        é‡ç ç»„åˆ—è¡¨
    }

    // åˆ†æå‰ 3000 å­—ä¸­å…¨ç é‡ç å’Œç®€ç å·®æŒ‡æ³•çš„æƒ…å†µ
    pub fn åˆ†æç è¡¨(
        &self,
        ç¼–ç ç»“æœ: &[å†°é›ªæ¸…éŸµç¼–ç ä¿¡æ¯],
        ç›®å½•: Option<PathBuf>,
    ) -> Result<(), é”™è¯¯> {
        let åˆ†æè·¯å¾„ = ç›®å½•
            .unwrap_or_else(|| PathBuf::from("output"))
            .join("åˆ†æ.md");
        let mut æ–‡ä»¶ = File::create(åˆ†æè·¯å¾„).unwrap();
        let mut äºŒç å­—æ ¹å­— = FxHashMap::default();
        let mut ä¸‰ç å­—æ ¹å­— = FxHashMap::default();
        let mut æ— ç†ä¸€ç®€å¤šé‡ = FxHashMap::default();
        let mut äºŒç®€ = FxHashMap::default();
        for (åºå·, ç¼–ç ä¿¡æ¯) in ç¼–ç ç»“æœ.iter().enumerate() {
            let è¯ = self.å›ºå®šæ‹†åˆ†[åºå·].è¯;
            let é¢‘ç‡ = ç¼–ç ä¿¡æ¯.ç®€ä½“é¢‘ç‡ * 10000.0;
            if !self.å›ºå®šæ‹†åˆ†[åºå·].é€šè§„ {
                continue;
            }
            if ç¼–ç ä¿¡æ¯.å­—æ ¹å­— {
                let å…¨ç  = self.è½¬ç¼–ç (ç¼–ç ä¿¡æ¯.å…¨ç );
                let ç¬¬ä¸€ç  = å…¨ç .chars().next().unwrap();
                if ç¼–ç ä¿¡æ¯.å…¨ç  == ç¼–ç ä¿¡æ¯.ç®€ä½“ç®€ç  {
                    äºŒç å­—æ ¹å­—
                        .entry(ç¬¬ä¸€ç )
                        .or_insert_with(Vec::new)
                        .push(format!("{è¯} {å…¨ç } {é¢‘ç‡:.0}"));
                } else {
                    ä¸‰ç å­—æ ¹å­—
                        .entry(ç¬¬ä¸€ç )
                        .or_insert_with(Vec::new)
                        .push(format!("{è¯} {å…¨ç } {é¢‘ç‡:.0}"));
                }
            } else {
                let ç®€ç  = self.è½¬ç¼–ç (ç¼–ç ä¿¡æ¯.ç®€ä½“ç®€ç );
                if ç®€ç .len() == 2 {
                    let ç¬¬ä¸€ç  = ç®€ç .chars().next().unwrap();
                    æ— ç†ä¸€ç®€å¤šé‡
                        .entry(ç¬¬ä¸€ç )
                        .or_insert_with(Vec::new)
                        .push(format!("{è¯} {ç®€ç } {é¢‘ç‡:.0}"));
                } else if ç®€ç .len() == 3 && ç®€ç .ends_with("_") {
                    let ç¬¬ä¸€ç  = ç®€ç .chars().next().unwrap();
                    äºŒç®€
                        .entry(ç¬¬ä¸€ç )
                        .or_insert_with(Vec::new)
                        .push(format!("{è¯} {ç®€ç } {é¢‘ç‡:.0}"));
                }
            }
        }
        writeln!(
            æ–‡ä»¶,
            "# æ— ç†ä¸€ç®€å¤šé‡ {}\n",
            æ— ç†ä¸€ç®€å¤šé‡.values().map(|x| x.len()).sum::<usize>()
        )?;
        for (ç¬¬ä¸€ç , åˆ—è¡¨) in æ— ç†ä¸€ç®€å¤šé‡.iter().sorted_by_key(|x| x.0) {
            writeln!(æ–‡ä»¶, "- {ç¬¬ä¸€ç }: {}", åˆ—è¡¨.join(" "))?;
        }
        writeln!(
            æ–‡ä»¶,
            "\n# äºŒç å­—æ ¹å­— {}\n",
            äºŒç å­—æ ¹å­—.values().map(|x| x.len()).sum::<usize>()
        )?;
        for (ç¬¬ä¸€ç , åˆ—è¡¨) in äºŒç å­—æ ¹å­—.iter().sorted_by_key(|x| x.0) {
            writeln!(æ–‡ä»¶, "- {ç¬¬ä¸€ç }: {}", åˆ—è¡¨.join(" "))?;
        }
        writeln!(
            æ–‡ä»¶,
            "\n# äºŒç®€ {}\n",
            äºŒç®€.values().map(|x| x.len()).sum::<usize>()
        )?;
        for (ç¬¬ä¸€ç , åˆ—è¡¨) in äºŒç®€.iter().sorted_by_key(|x| x.0) {
            writeln!(æ–‡ä»¶, "- {ç¬¬ä¸€ç }: {}", åˆ—è¡¨.join(" "))?;
        }
        writeln!(
            æ–‡ä»¶,
            "\n# ä¸‰ç å­—æ ¹å­— {}\n",
            ä¸‰ç å­—æ ¹å­—.values().map(|x| x.len()).sum::<usize>()
        )?;
        for (ç¬¬ä¸€ç , åˆ—è¡¨) in ä¸‰ç å­—æ ¹å­—.iter().sorted_by_key(|x| x.0) {
            writeln!(æ–‡ä»¶, "- {ç¬¬ä¸€ç }: {}", åˆ—è¡¨.join(" "))?;
        }
        let ç®€ä½“å‰ä¸‰åƒ: Vec<_> = self.ç®€ä½“é¡ºåº.iter().take(3000).cloned().collect();
        let ç¹ä½“å‰ä¸‰åƒ: Vec<_> = self.ç¹ä½“é¡ºåº.iter().take(3000).cloned().collect();
        let é€šæ‰“å‰ä¸‰åƒ: Vec<_> = (0..3000).collect();
        let æŒ‡æ³•æ ‡è®° = æŒ‡æ³•æ ‡è®°::new();
        let mut å·®æŒ‡æ³• = vec![];
        let mut å››é”®å­— = vec![];
        let mut ä¸‰é”®å­— = vec![];
        for &åºå· in ç®€ä½“å‰ä¸‰åƒ.iter() {
            let ç¼–ç ä¿¡æ¯ = &ç¼–ç ç»“æœ[åºå·];
            let è¯ = self.å›ºå®šæ‹†åˆ†[åºå·].è¯;
            let ç®€ç  = self.è½¬ç¼–ç (ç¼–ç ä¿¡æ¯.ç®€ä½“ç®€ç );
            if ç®€ç .len() == 3 && åºå· < 200 {
                ä¸‰é”®å­—.push((è¯, ç®€ç .clone(), ç¼–ç ä¿¡æ¯.ç®€ä½“é¢‘ç‡));
            }
            if ç®€ç .len() == 4 && åºå· < 500 {
                å››é”®å­—.push((è¯, ç®€ç .clone(), ç¼–ç ä¿¡æ¯.ç®€ä½“é¢‘ç‡));
            }
            if åºå· < 1500 {
                let ç®€ç : Vec<char> = ç®€ç .chars().collect();
                for é”®ç´¢å¼• in 0..(ç®€ç .len() - 1) {
                    let ç»„åˆ = (ç®€ç [é”®ç´¢å¼•], ç®€ç [é”®ç´¢å¼• + 1]);
                    if æŒ‡æ³•æ ‡è®°.åŒæŒ‡å¤§è·¨æ’.contains(&ç»„åˆ) || æŒ‡æ³•æ ‡è®°.é”™æ‰‹.contains(&ç»„åˆ)
                    {
                        å·®æŒ‡æ³•.push((è¯, ç®€ç .iter().collect::<String>()));
                        break;
                    }
                }
            }
        }
        writeln!(æ–‡ä»¶, "\n# å‰ 1500 ä¸­ç®€ç å·®æŒ‡æ³•é¡¹\n")?;
        for (å­—, ç¼–ç ) in å·®æŒ‡æ³• {
            write!(æ–‡ä»¶, "{å­—} {ç¼–ç }ï¼›")?;
        }
        writeln!(æ–‡ä»¶, "\n\n# å‰ 200 ä¸­ä¸‰é”®å­—\n").unwrap();
        for (å­—, ç¼–ç , é¢‘ç‡) in ä¸‰é”®å­— {
            write!(æ–‡ä»¶, "{å­—} {ç¼–ç } {:.0}ï¼›", é¢‘ç‡ * 10000.0)?;
        }
        writeln!(æ–‡ä»¶, "\n\n# å‰ 500 ä¸­å››é”®å­—\n").unwrap();
        for (å­—, ç¼–ç , é¢‘ç‡) in å››é”®å­— {
            write!(æ–‡ä»¶, "{å­—} {ç¼–ç } {:.0}ï¼›", é¢‘ç‡ * 10000.0)?;
        }
        writeln!(æ–‡ä»¶, "")?;
        let ç®€ä½“é‡ç ç»„åˆ—è¡¨ = self.ç¿»è½¬ç è¡¨(ç¼–ç ç»“æœ, &ç®€ä½“å‰ä¸‰åƒ, &|x| x.ç®€ä½“é¢‘ç‡);
        let ç¹ä½“é‡ç ç»„åˆ—è¡¨ = self.ç¿»è½¬ç è¡¨(ç¼–ç ç»“æœ, &ç¹ä½“å‰ä¸‰åƒ, &|x| x.ç¹ä½“é¢‘ç‡);
        let é€šæ‰“é‡ç ç»„åˆ—è¡¨ = self.ç¿»è½¬ç è¡¨(ç¼–ç ç»“æœ, &é€šæ‰“å‰ä¸‰åƒ, &|x| x.é€šæ‰“é¢‘ç‡);
        for (label, é‡ç ç»„åˆ—è¡¨) in [
            ("ç®€ä½“", ç®€ä½“é‡ç ç»„åˆ—è¡¨),
            ("ç¹ä½“", ç¹ä½“é‡ç ç»„åˆ—è¡¨),
            ("é€šæ‰“", é€šæ‰“é‡ç ç»„åˆ—è¡¨),
        ] {
            writeln!(æ–‡ä»¶, "\n# å‰ 3000 ä¸­{label}å…¨ç é‡ç \n")?;
            for (å…¨ç , é‡ç ç»„, æ¬¡é€‰é¢‘ç‡) in é‡ç ç»„åˆ—è¡¨ {
                let å…¨ç  = self.è½¬ç¼–ç (å…¨ç );
                let ç™¾ä¸‡åˆ†ä¹‹é¢‘ç‡ = æ¬¡é€‰é¢‘ç‡ * 1_000_000.0;
                writeln!(æ–‡ä»¶, "- {å…¨ç } {é‡ç ç»„:?} [{ç™¾ä¸‡åˆ†ä¹‹é¢‘ç‡:.2} Î¼]")?;
            }
        }
        Ok(())
    }
}
